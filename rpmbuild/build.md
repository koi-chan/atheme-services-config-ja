# rpmbuild の手順

## 環境

Linux ディストリビューション:	CentOS 6.5 x86_64  
操作系:				CUI (Bash)  
SELinuxの設定:			Permissive  
インストール済みYUMレポジトリ:	EPEL, Remi  
最終ビルド日:			2014-09-12  


## 1\. ビルド環境の作成

rpm ファイルの作成も「ビルド」というそうなので、以後この表現を使っていきます。

まず、ビルドに使う rpmbuild コマンドをシステムにインストールします。

```
# yum install rpmbuild rpmdevtools
```

続いて、実際にビルドするのに使う一般ユーザーになります。
大抵はそのユーザーから su するなり sudo するなりして上のコマンドを発行すると思いますが。

なお、ビルド途中には、 make install する工程が含まれます。
そのとき、SPECファイルに不備があるとシステムに中途半端な状態のプログラムがインストールされてしまいます。
*絶対に、管理者権限を持ったユーザーで rpmbuild を実行しない*ようにしてください。

さて、上記のパッケージがインストールできたら、ビルドユーザーのホームに作業用ディレクトリを作成します。
その時、過去に使った作業用ディレクトリがあると、ファイルが衝突したり、後々わかりづらくなってしまうことがありますので、可能ならば前に使ったディレクトリはリネームするなり削除するなりして、今回のビルド用に新しくディレクトリを用意することをお勧めします。
バックアップの際には .rpmmacros もお忘れなく。

さて、コマンド一発でディレクトリを拵えてしまいましょう。

```
$ rpmdev-setuptree
```

すると、どこを作業用ディレクトリにするかを定義するファイルと作業用ディレクトリを、ホームディレクトリ直下に一括して用意してくれます。
標準でないところに変えたい人は、手動で設定したり作ったりしてください。

エラーが出てしまうことがあるので、 ~/.rpmmacros を書き換えます。
ビルドに使う設定を記述するファイルです。

3行目、"%__arch_install_post"で始まる行の頭に半角シャープを入れてコメントアウトします。

以上で、ビルド環境の作成は完了です。


## 2\. ビルドするためのファイルの設置

作業用ディレクトリに必要なファイルを設置します。必要なものは以下の3つです。

* SPEC ファイル
* オリジナルの tar アーカイブ
* SysVinit 用のデーモン起動スクリプト

3つ目は、システム起動時に自動的にデーモンを起動するために必要なものです。自動起動なんてしないという方は省略できます。
ただし、SPECファイルの書き換えが必要になるのでその部分を読み飛ばさないようにしてください。

### SPEC ファイル

先ほども説明した、ビルドに必要な手順ファイル。
このファイルと同じ階層に保存してあります、"atheme.spec"をダウンロードして、"rpmbuild/SPEC/"ディレクトリに保存してください。

デーモン起動スクリプトを使わない方は SPEC ファイルをテキストエディタで開いて、以下の2行を削除するか、行頭に半角シャープを挿入してコメントアウトしてください。

```
mkdir -p %{buildroot}%{_initddir}
cp %{_sourcedir}/atheme-services %{buildroot}%{_initddir}/atheme-services
```


### オリジナルの tar アーカイブ

[Atheme IRC Services の公式サイト](http://atheme.net/atheme.html)からダウンロードします。  
解凍せず、そのまま"rpmbuild/SOURCES/"に保存します。


### SysVinit 用のデーモン起動スクリプト

SPECファイルと同様にダウンロードし、こちらはアーカイブと同じ場所に保存します。  
ファイル名を変更しないようにしてください。

以上で、必要なファイルは集まりました。


## 3\. rpmのビルドとインストール

以下のコマンドを発行し、ビルドを開始します。

```
$ rpmbuild -bb rpmbuild/SPEC/atheme.spec
```

SPECファイルのパスは、各自の環境に置き換えて実行してください。  
こちらでは、ホームディレクトリをカレントディレクトリにしてから上のコマンドで実行しました。

SPECファイルを作った時には、すでに当方のシステムにはいろいろなパッケージが入っていました。ですので、SPECファイル内の依存パッケージの項目は不正確なものになってしまっています。

画面がエラー終了した時には、必要そうなパッケージをインストールしてください。  
大抵は yum でインストールできるはずです。EPELリポジトリを使えるようにしている当方の環境では、ソースからインストールしなければならなかった追加プログラムはありませんでした。

正常にビルドされると、"rpmbuild/RPMS/"以下のサブディレクトリに rpm ファイルがぽつんと置かれているはずです。あとは普通に、 rpm コマンドを使ってインストールするだけです。

```
# rpm -ivh rpmbuild/RPMS/x86_64/atheme-services-7.1.0-1.el6.x86_64.rpm
```


以上でビルドとインストールが完了しました。


### 4\. Atheme IRC Services を動かすための初期設定


